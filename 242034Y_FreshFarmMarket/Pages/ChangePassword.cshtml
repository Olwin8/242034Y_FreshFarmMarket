@page
@model _242034Y_FreshFarmMarket.Pages.ChangePasswordModel
@{
    ViewData["Title"] = "Change Password - Fresh Farm Market";
    Layout = "_Layout";
}

@section Styles {
    <style>
        :root {
            --primary-green: #2ecc71;
            --dark-green: #27ae60;
            --light-green: #d5f4e6;
            --cream-white: #f9f6f0;
            --leaf-green: #229954;
            --success-gradient: linear-gradient(90deg, #2ecc71, #229954);
            --weak-red: #dc3545;
        }

        body {
            background: linear-gradient(135deg, #f9f6f0 0%, #e8f5e9 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .cp-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(46, 204, 113, 0.15);
            overflow: hidden;
            border: 2px solid var(--light-green);
            position: relative;
            margin: 2rem auto;
            max-width: 720px;
        }

        .cp-header {
            background: var(--success-gradient);
            color: white;
            padding: 2.2rem;
            text-align: center;
        }

        .cp-body {
            padding: 2.5rem;
        }

        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1rem 1.2rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--cream-white);
        }

            .form-control:focus {
                border-color: var(--primary-green);
                box-shadow: 0 0 0 0.25rem rgba(46, 204, 113, 0.25);
                background: white;
            }

        .btn-save {
            background: var(--success-gradient);
            border: none;
            color: white;
            padding: 1.1rem 2rem;
            border-radius: 15px;
            font-size: 1.15rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        /* ✅ Same password strength UI styles as Register */
        .password-strength-container {
            margin-top: 1rem;
            padding: 1.5rem;
            border-radius: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .strength-meter {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 1rem 0;
            position: relative;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 5px;
        }

        .strength-text {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        .suggestion-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0 0;
        }

            .suggestion-list li {
                padding: 0.4rem 0;
                color: #6c757d;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

                .suggestion-list li.valid {
                    color: var(--primary-green);
                }

                .suggestion-list li.invalid {
                    color: var(--weak-red);
                }

        .password-criteria {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .criteria-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

            .criteria-item i {
                margin-right: 0.5rem;
                width: 20px;
                text-align: center;
            }

            .criteria-item.met {
                color: var(--primary-green);
            }

            .criteria-item.not-met {
                color: #6c757d;
            }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
    </style>
}

<div class="cp-container">
    <div class="cp-header">
        <h2 class="mb-0"><i class="fas fa-key me-2"></i>Change Password</h2>
        <p class="mb-0" style="opacity:.95;">Password reuse blocked (current + last 2)</p>
    </div>

    <div class="cp-body">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success rounded-3" id="successAlert">@TempData["Success"]</div>
        }

        <form method="post" id="changePasswordForm">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger rounded-3"></div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Current Password</label>
                <input asp-for="CModel.CurrentPassword" class="form-control" />
                <span asp-validation-for="CModel.CurrentPassword" class="text-danger small"></span>
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">New Password</label>
                <input asp-for="CModel.NewPassword" class="form-control" id="passwordInput" autocomplete="new-password" />
                <span asp-validation-for="CModel.NewPassword" class="text-danger small"></span>

                <!-- ✅ SAME Password Strength Indicator (as Register) -->
                <div class="password-strength-container" id="passwordStrengthContainer">
                    <div class="progress-label">
                        <strong>Password Strength:</strong>
                        <span id="strengthText" class="strength-text">Not set</span>
                    </div>
                    <div class="strength-meter">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <div class="password-criteria">
                        <div class="criteria-item" id="lengthCriteria">
                            <i class="fas fa-times-circle text-danger"></i>
                            <span>At least 12 characters</span>
                        </div>
                        <div class="criteria-item" id="lowerCriteria">
                            <i class="fas fa-times-circle text-danger"></i>
                            <span>Lowercase letter (a-z)</span>
                        </div>
                        <div class="criteria-item" id="upperCriteria">
                            <i class="fas fa-times-circle text-danger"></i>
                            <span>Uppercase letter (A-Z)</span>
                        </div>
                        <div class="criteria-item" id="numberCriteria">
                            <i class="fas fa-times-circle text-danger"></i>
                            <span>Number (0-9)</span>
                        </div>
                        <div class="criteria-item" id="specialCriteria">
                            <i class="fas fa-times-circle text-danger"></i>
                            <span>Special character (!&#64;#$%^&amp;*)</span>
                        </div>
                    </div>
                    <div class="suggestions mt-2">
                        <ul class="suggestion-list" id="suggestionList">
                            @if (Model.PasswordSuggestions.Any())
                            {
                                foreach (var suggestion in Model.PasswordSuggestions)
                                {
                                    <li class="@(suggestion.StartsWith("✓") ? "valid" : "invalid")">
                                        <i class="@(suggestion.StartsWith("✓") ? "fas fa-check-circle" : "fas fa-exclamation-circle")"></i>
                                        @suggestion
                                    </li>
                                }
                            }
                            else
                            {
                                <li>Enter a password to see requirements</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-semibold">Confirm New Password</label>
                <input asp-for="CModel.ConfirmNewPassword" class="form-control" id="confirmPasswordInput" autocomplete="new-password" />
                <span asp-validation-for="CModel.ConfirmNewPassword" class="text-danger small"></span>
                <div class="mt-1 small" id="passwordMatch"></div>
            </div>

            <button type="submit" class="btn-save" id="updateBtn">
                <i class="fas fa-save me-2"></i> Update Password
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // ✅ Auto-redirect AFTER showing success message first
            const shouldRedirect = @Model.ShouldRedirectToHome.ToString().ToLower();
            const delaySeconds = @Model.RedirectDelaySeconds;

            if (shouldRedirect) {
                setTimeout(function () {
                    window.location.href = "/Index";
                }, (delaySeconds || 2) * 1000);
            }

            // ✅ SAME password strength JS flow as Register (wired to Change Password handler)
            const passwordInput = document.getElementById('passwordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const strengthText = document.getElementById('strengthText');
            const strengthFill = document.getElementById('strengthFill');
            const strengthContainer = document.getElementById('passwordStrengthContainer');

            function getStrengthColor(strength) {
                switch ((strength || '').toLowerCase()) {
                    case 'very weak': return '#dc3545';
                    case 'weak': return '#fd7e14';
                    case 'good': return '#ffc107';
                    case 'strong': return '#20c997';
                    case 'very strong': return '#28a745';
                    default: return '#6c757d';
                }
            }

            function updateStrengthUI(score, strength, color) {
                if (strengthText) {
                    strengthText.textContent = strength;
                    strengthText.style.color = color;
                }
                if (strengthFill) {
                    strengthFill.style.width = score + '%';
                    strengthFill.style.backgroundColor = color;
                }
                if (strengthContainer) {
                    strengthContainer.style.borderColor = color;
                    strengthContainer.style.boxShadow = '0 0 0 0.2rem ' + color + '20';
                }
            }

            function updateCriteria(password) {
                const hasLength = password.length >= 12;
                const hasLower = /[a-z]/.test(password);
                const hasUpper = /[A-Z]/.test(password);
                const hasNumber = /\d/.test(password);
                const hasSpecial = /[^\w\d\s]/.test(password);

                const lengthCriteria = document.getElementById('lengthCriteria');
                if (lengthCriteria) {
                    lengthCriteria.className = 'criteria-item ' + (hasLength ? 'met' : 'not-met');
                    lengthCriteria.innerHTML =
                        '<i class="fas fa-' + (hasLength ? 'check' : 'times') + '-circle ' + (hasLength ? 'text-success' : 'text-danger') + '"></i>' +
                        '<span>At least 12 characters ' + (hasLength ? '(' + password.length + ')' : '') + '</span>';
                }

                const lowerCriteria = document.getElementById('lowerCriteria');
                if (lowerCriteria) {
                    lowerCriteria.className = 'criteria-item ' + (hasLower ? 'met' : 'not-met');
                    lowerCriteria.innerHTML =
                        '<i class="fas fa-' + (hasLower ? 'check' : 'times') + '-circle ' + (hasLower ? 'text-success' : 'text-danger') + '"></i>' +
                        '<span>Lowercase letter (a-z)</span>';
                }

                const upperCriteria = document.getElementById('upperCriteria');
                if (upperCriteria) {
                    upperCriteria.className = 'criteria-item ' + (hasUpper ? 'met' : 'not-met');
                    upperCriteria.innerHTML =
                        '<i class="fas fa-' + (hasUpper ? 'check' : 'times') + '-circle ' + (hasUpper ? 'text-success' : 'text-danger') + '"></i>' +
                        '<span>Uppercase letter (A-Z)</span>';
                }

                const numberCriteria = document.getElementById('numberCriteria');
                if (numberCriteria) {
                    numberCriteria.className = 'criteria-item ' + (hasNumber ? 'met' : 'not-met');
                    numberCriteria.innerHTML =
                        '<i class="fas fa-' + (hasNumber ? 'check' : 'times') + '-circle ' + (hasNumber ? 'text-success' : 'text-danger') + '"></i>' +
                        '<span>Number (0-9)</span>';
                }

                const specialCriteria = document.getElementById('specialCriteria');
                if (specialCriteria) {
                    specialCriteria.className = 'criteria-item ' + (hasSpecial ? 'met' : 'not-met');
                    specialCriteria.innerHTML =
                        '<i class="fas fa-' + (hasSpecial ? 'check' : 'times') + '-circle ' + (hasSpecial ? 'text-success' : 'text-danger') + '"></i>' +
                        '<span>Special character (!&#64;#$%^&amp;*)</span>';
                }
            }

            function updateSuggestions(suggestions) {
                const suggestionList = document.getElementById('suggestionList');
                if (!suggestionList || !suggestions) return;

                suggestionList.innerHTML = '';
                suggestions.forEach(function (suggestion) {
                    const li = document.createElement('li');
                    const isValid = suggestion.startsWith('✓');
                    li.className = isValid ? 'valid' : 'invalid';
                    li.innerHTML =
                        '<i class="' + (isValid ? 'fas fa-check-circle' : 'fas fa-exclamation-circle') + '"></i> ' +
                        suggestion;
                    suggestionList.appendChild(li);
                });
            }

            function checkPasswordStrength(password) {
                if (!password) {
                    updateStrengthUI(0, 'Not set', '#6c757d');
                    updateCriteria('');
                    return;
                }

                fetch(`?handler=CheckPassword&password=${encodeURIComponent(password)}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        updateStrengthUI(data.score, data.strength, getStrengthColor(data.strength));
                        updateCriteria(password);
                        updateSuggestions(data.suggestions);
                    })
                    .catch(_ => {
                        updateStrengthUI(0, 'Error', '#dc3545');
                    });
            }

            function checkPasswordMatch() {
                const matchDiv = document.getElementById('passwordMatch');
                if (!matchDiv || !passwordInput || !confirmPasswordInput) return;

                const p = passwordInput.value || '';
                const c = confirmPasswordInput.value || '';

                if (!p || !c) {
                    matchDiv.innerHTML = '';
                    return;
                }

                if (p === c) {
                    matchDiv.innerHTML = '<div class="text-success"><i class="fas fa-check-circle"></i> Passwords match</div>';
                } else {
                    matchDiv.innerHTML = '<div class="text-danger"><i class="fas fa-times-circle"></i> Passwords do not match</div>';
                }
            }

            if (passwordInput) {
                passwordInput.addEventListener('input', function () {
                    checkPasswordStrength(this.value);
                    checkPasswordMatch();
                });

                // if value exists (rare), refresh UI
                if (passwordInput.value) {
                    setTimeout(function () {
                        checkPasswordStrength(passwordInput.value);
                        checkPasswordMatch();
                    }, 100);
                }
            }

            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            }
        });
    </script>
}
